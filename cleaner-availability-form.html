<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4-Week Availability Submission</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            max-width: 700px;
            width: 100%;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .progress-bar {
            width: 100%;
            background-color: #e2e8f0;
            height: 8px;
        }

        .progress-bar-fill {
            width: 0%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #a270d0 100%);
            transition: width 0.4s ease-in-out;
        }

        .header {
            background: #f7f8fc;
            color: #2d3748;
            padding: 20px 30px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            color: #718096;
            font-size: 14px;
        }
        
        .form-step {
            padding: 30px 40px;
        }

        .form-content {
            padding: 0;
        }

        .form-group {
            margin-bottom: 28px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .required {
            color: #e53e3e;
        }

        input[type="text"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
            font-family: inherit;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .radio-option:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .radio-option input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-right: 12px;
        }

        .radio-option.selected {
            border-color: #667eea;
            background: #eef2ff;
        }

        .day-availability {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .day-availability h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .checkbox-option:hover {
            background: white;
        }

        .checkbox-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .time-slot-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #e2e8f0;
        }

        .time-slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .time-slot-header h3 {
            color: #667eea;
            font-size: 16px;
        }

        .remove-slot-btn {
            background: #fc8181;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .time-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .add-slot-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .nav-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .nav-btn.prev-btn {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .nav-btn.prev-btn:hover {
             background: #cbd5e0;
             box-shadow: 0 5px 15px rgba(0,0,0, 0.1);
        }

        .submit-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .submit-btn:hover {
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.3);
        }

        .loading, .success-message {
            text-align: center;
            padding: 80px 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .icon {
            font-size: 20px;
            margin-right: 8px;
        }
        
        .week-header {
             font-size: 20px;
             color: #2d3748;
             margin-bottom: 25px;
             border-bottom: 2px solid #e2e8f0;
             padding-bottom: 10px;
        }
        
        .week-header span {
            font-weight: 400;
            color: #718096;
            font-size: 16px;
        }
        
        .review-section {
            padding: 30px 40px;
        }
        
        .review-week {
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .review-week h4 {
            color: #667eea;
            margin-bottom: 8px;
        }
        .review-week p {
            color: #4a5568;
            font-size: 14px;
        }
        
        .previous-week-summary {
            background: #eef2ff;
            border: 1px solid #c3dafe;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            font-size: 13px;
            color: #4a5568;
        }
        
        .previous-week-summary h4 {
            font-size: 14px;
            color: #5a67d8;
            margin-bottom: 8px;
        }

    </style>
</head>
<body>
    <div class="container">
        <div id="loadingMessage" class="loading">
            <div class="spinner"></div>
            <p>Loading Cleaners...</p>
        </div>

        <div id="mainForm" class="hidden">
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progressBar"></div>
            </div>
            <div class="header">
                <h1 id="headerTitle">🧹 4-Week Availability</h1>
                <p id="headerSubtitle">Step 1: Select your name</p>
            </div>
            <div class="form-content">
                <div id="errorMessage" class="error hidden"></div>

                <form id="availabilityForm">
                    <!-- Step 1: Name -->
                    <div class="form-step" data-step="1">
                        <div class="week-header">Step 1: Your Information</div>
                        <div class="form-group">
                            <label>Your Name: <span class="required">*</span></label>
                            <select id="cleanerName" required>
                                <option value="">Select your name...</option>
                            </select>
                        </div>
                        <div class="nav-buttons">
                           <span></span>
                           <button type="button" class="nav-btn next-btn" onclick="nextStep()">Next</button>
                        </div>
                    </div>

                    <!-- Steps 2-5 will be generated here -->

                    <!-- Step 6: Review -->
                    <div class="form-step hidden" data-step="6">
                         <div class="week-header">Step 6: Review Your Submission</div>
                         <div id="reviewContainer"></div>
                         <div class="nav-buttons">
                           <button type="button" class="nav-btn prev-btn" onclick="prevStep()">Back</button>
                           <button type="submit" class="nav-btn submit-btn">Submit All 4 Weeks</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
         <div id="successMessage" class="success-message hidden">
            <h2>✅ All Done!</h2>
            <p>Your availability for the next 4 weeks has been submitted successfully.</p>
        </div>
    </div>

<script>
    // State Management
    let currentStep = 1;
    let totalSteps = 6;
    let cleaners = [];
    let weeklyData = [{}, {}, {}, {}];
    const weekStartDates = [];
    let timeSlotCounts = [0, 0, 0, 0];

    // --- UTILITY ---
    function getUrlParams() {
        return { name: new URLSearchParams(window.location.search).get('name') };
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
        setTimeout(() => errorDiv.classList.add('hidden'), 5000);
    }
    
    function updateProgressBar() {
        const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
        document.getElementById('progressBar').style.width = `${progress}%`;
        const subtitles = [
            "Step 1: Select your name",
            `Step 2: Availability for Week 1 (${formatDate(weekStartDates[0])})`,
            `Step 3: Availability for Week 2 (${formatDate(weekStartDates[1])})`,
            `Step 4: Availability for Week 3 (${formatDate(weekStartDates[2])})`,
            `Step 5: Availability for Week 4 (${formatDate(weekStartDates[3])})`,
            "Step 6: Review Your Submission"
        ];
        document.getElementById('headerSubtitle').textContent = subtitles[currentStep - 1];
    }
    
    function formatDate(date) {
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }
    
    // --- NAVIGATION ---
    function nextStep() {
        if (!validateStep(currentStep)) return;
        saveStepData(currentStep);
        if (currentStep < totalSteps) {
            document.querySelector(`[data-step="${currentStep}"]`).classList.add('hidden');
            currentStep++;
            document.querySelector(`[data-step="${currentStep}"]`).classList.remove('hidden');
            if (currentStep === totalSteps) buildReviewPage();
            updateProgressBar();
        }
    }

    function prevStep() {
        if (currentStep > 1) {
            document.querySelector(`[data-step="${currentStep}"]`).classList.add('hidden');
            currentStep--;
            document.querySelector(`[data-step="${currentStep}"]`).classList.remove('hidden');
            updateProgressBar();
        }
    }
    
    // --- DATA HANDLING AND VALIDATION ---
    function validateStep(step) {
        if (step === 1) {
            if (document.getElementById('cleanerName').value === '') {
                showError("Please select your name.");
                return false;
            }
        }
        if (step >= 2 && step <= 5) {
            const weekIndex = step - 2;
            const type = document.querySelector(`input[name="submissionType_${weekIndex}"]:checked`)?.value;
            if (!type) {
                showError("Please choose a submission method for this week.");
                return false;
            }
            if (type === 'eachDay') {
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                for (const day of days) {
                    if (document.querySelectorAll(`input[name="${day}_${weekIndex}"]:checked`).length === 0) {
                        showError(`Please select an option for every day of the week.`);
                        return false;
                    }
                }
            }
             if (type === 'timeSlots' && timeSlotCounts[weekIndex] === 0) {
                showError(`Please add at least one time slot for this week.`);
                return false;
            }
        }
        document.getElementById('errorMessage').classList.add('hidden');
        return true;
    }
    
    function saveStepData(step) {
        if (step >= 2 && step <= 5) {
            const weekIndex = step - 2;
            const type = document.querySelector(`input[name="submissionType_${weekIndex}"]:checked`)?.value;
            
            // This is a deep copy to handle the "sameAsPrevious" chaining correctly.
            if (type === 'sameAsPrevious') {
                weeklyData[weekIndex] = JSON.parse(JSON.stringify(weeklyData[weekIndex - 1]));
                // We still mark its original type for the review page.
                weeklyData[weekIndex].submissionTypeForReview = 'sameAsPrevious';
                return; // Stop here after copying
            }

            // Otherwise, build the data object from the form fields.
            const data = { submissionType: type, submissionTypeForReview: type };

            if (type === 'eachDay') {
                data.days = {
                    monday: Array.from(document.querySelectorAll(`input[name="monday_${weekIndex}"]:checked`)).map(c => c.value).join(', '),
                    tuesday: Array.from(document.querySelectorAll(`input[name="tuesday_${weekIndex}"]:checked`)).map(c => c.value).join(', '),
                    wednesday: Array.from(document.querySelectorAll(`input[name="wednesday_${weekIndex}"]:checked`)).map(c => c.value).join(', '),
                    thursday: Array.from(document.querySelectorAll(`input[name="thursday_${weekIndex}"]:checked`)).map(c => c.value).join(', '),
                    friday: Array.from(document.querySelectorAll(`input[name="friday_${weekIndex}"]:checked`)).map(c => c.value).join(', '),
                    saturday: Array.from(document.querySelectorAll(`input[name="saturday_${weekIndex}"]:checked`)).map(c => c.value).join(', '),
                    sunday: Array.from(document.querySelectorAll(`input[name="sunday_${weekIndex}"]:checked`)).map(c => c.value).join(', '),
                };
            } else if (type === 'timeSlots') {
                data.timeSlots = [];
                const slots = document.querySelectorAll(`#timeSlotsContainer_${weekIndex} .time-slot-container`);
                slots.forEach((slot) => {
                     data.timeSlots.push({
                        day: slot.querySelector(`select[name^="slotDay"]`).value,
                        start: slot.querySelector(`select[name^="slotStart"]`).value,
                        end: slot.querySelector(`select[name^="slotEnd"]`).value,
                    });
                });
            }
            weeklyData[weekIndex] = data;
        }
    }
    
    function buildReviewPage() {
        const container = document.getElementById('reviewContainer');
        container.innerHTML = '';
        weeklyData.forEach((data, index) => {
            const weekDiv = document.createElement('div');
            weekDiv.className = 'review-week';

            let content = `<h4>Week ${index + 1} (${formatDate(weekStartDates[index])})</h4>`;
            if (data.submissionTypeForReview === 'sameAsPrevious') {
                 content += `<p>✅ Same as Week ${index}</p>`;
            } else if (data.submissionType === 'eachDay') {
                 content += `<p>📝 Submitted availability for each day.</p>`;
            } else if (data.submissionType === 'timeSlots') {
                 content += `<p>🎯 Submitted ${data.timeSlots ? data.timeSlots.length : 0} specific time slot(s).</p>`;
            } else {
                 content += `<p>No availability submitted for this week.</p>`;
            }
            weekDiv.innerHTML = content;
            container.appendChild(weekDiv);
        });
    }

    // --- DYNAMIC UI ---
    function generateWeekForms() {
        const form = document.getElementById('availabilityForm');
        const reviewStep = form.querySelector('[data-step="6"]');
        for (let i = 0; i < 4; i++) {
            const step = i + 2;
            const weekStep = document.createElement('div');
            weekStep.className = 'form-step hidden';
            weekStep.dataset.step = step;

            const sameAsPreviousOption = i > 0 ? `
                <label class="radio-option">
                    <input type="radio" name="submissionType_${i}" value="sameAsPrevious">
                    <span><span class="icon">🔄</span>Use same availability as previous week</span>
                </label>
                <div class="previous-week-summary hidden" id="summaryContainer_${i}"></div>
                ` : '';

            weekStep.innerHTML = `
                <div class="week-header">Step ${step}: Week ${i + 1} <span>(${formatDate(weekStartDates[i])})</span></div>
                <div class="form-group">
                    <label>How would you like to submit your availability? <span class="required">*</span></label>
                    <div class="radio-group">
                        ${sameAsPreviousOption}
                        <label class="radio-option">
                            <input type="radio" name="submissionType_${i}" value="eachDay">
                            <span><span class="icon">📝</span>Fill out each day</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="submissionType_${i}" value="timeSlots">
                            <span><span class="icon">🎯</span>I can only work specific hours (part-time)</span>
                        </label>
                    </div>
                </div>
                <div class="each-day-section hidden">
                    ${['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].map(day => `
                        <div class="day-availability">
                            <h3>${day} <span class="required">*</span></h3>
                            <div class="checkbox-group">
                                ${['All Day (8am-8pm)', 'Morning (8am-12pm)', 'Afternoon (12pm-5pm)', 'Evening (5pm-8pm)', 'Not Available'].map(option => `
                                <label class="checkbox-option"><input type="checkbox" name="${day.toLowerCase()}_${i}" value="${option}"><span>${option}</span></label>`).join('')}
                            </div>
                        </div>`).join('')}
                </div>
                <div class="time-slot-section hidden">
                    <div id="timeSlotsContainer_${i}"></div>
                    <button type="button" class="add-slot-btn" onclick="addTimeSlot(${i})">+ Add Time Slot</button>
                </div>
                <div class="nav-buttons">
                    <button type="button" class="nav-btn prev-btn" onclick="prevStep()">Back</button>
                    <button type="button" class="nav-btn next-btn" onclick="nextStep()">Next</button>
                </div>`;
            form.insertBefore(weekStep, reviewStep);
        }
        addEventListenersToWeekForms();
    }
    
    function addEventListenersToWeekForms() {
        document.querySelectorAll('input[name^="submissionType_"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const weekIndex = parseInt(e.target.name.split('_')[1]);
                const stepElement = e.target.closest('.form-step');
                const eachDaySection = stepElement.querySelector('.each-day-section');
                const timeSlotSection = stepElement.querySelector('.time-slot-section');
                const summaryContainer = stepElement.querySelector(`#summaryContainer_${weekIndex}`);
                
                eachDaySection.classList.add('hidden');
                timeSlotSection.classList.add('hidden');
                if(summaryContainer) summaryContainer.classList.add('hidden');

                if (e.target.value === 'eachDay') {
                    eachDaySection.classList.remove('hidden');
                } else if (e.target.value === 'timeSlots') {
                    timeSlotSection.classList.remove('hidden');
                    if (timeSlotCounts[weekIndex] === 0) addTimeSlot(weekIndex);
                } else if (e.target.value === 'sameAsPrevious') {
                    if (summaryContainer) {
                        updatePreviousWeekSummary(weekIndex);
                        summaryContainer.classList.remove('hidden');
                    }
                }
            });
        });
    }

    function updatePreviousWeekSummary(weekIndex) {
        // Trace back to find the original source data
        let sourceData = weeklyData[weekIndex - 1];
        let sourceIndex = weekIndex - 1;
        while(sourceData && sourceData.submissionType === 'sameAsPrevious' && sourceIndex > 0) {
            sourceIndex--;
            sourceData = weeklyData[sourceIndex];
        }

        const summaryContainer = document.getElementById(`summaryContainer_${weekIndex}`);
        if (!sourceData || Object.keys(sourceData).length === 0 || sourceData.submissionType === 'sameAsPrevious') {
            summaryContainer.innerHTML = '<h4>No data from previous week to display.</h4>';
            return;
        }
        
        let summaryHTML = `<h4>Preview of Week ${weekIndex} Availability:</h4>`;
        if (sourceData.submissionType === 'eachDay') {
            summaryHTML += '<ul>';
            for (const [day, availability] of Object.entries(sourceData.days)) {
                if(availability) summaryHTML += `<li><strong>${day.charAt(0).toUpperCase() + day.slice(1)}:</strong> ${availability}</li>`;
            }
            summaryHTML += '</ul>';
        } else if (sourceData.submissionType === 'timeSlots' && sourceData.timeSlots) {
            summaryHTML += `<ul>`;
            sourceData.timeSlots.forEach(slot => {
                 summaryHTML += `<li><strong>${slot.day}:</strong> ${slot.start} - ${slot.end}</li>`;
            });
            summaryHTML += `</ul>`;
        } else {
            summaryHTML += '<p>No specific availability set for previous week.</p>';
        }
        summaryContainer.innerHTML = summaryHTML;
    }
    
    function addTimeSlot(weekIndex) {
        if (timeSlotCounts[weekIndex] >= 7) return;
        timeSlotCounts[weekIndex]++;
        const container = document.getElementById(`timeSlotsContainer_${weekIndex}`);
        const slotDiv = document.createElement('div');
        slotDiv.className = 'time-slot-container';
        slotDiv.dataset.slotId = timeSlotCounts[weekIndex];
        
        slotDiv.innerHTML = `
            <div class="time-slot-header">
                <h3>Time Slot ${timeSlotCounts[weekIndex]}</h3>
                <button type="button" class="remove-slot-btn" onclick="this.parentElement.parentElement.remove(); timeSlotCounts[${weekIndex}]--;">Remove</button>
            </div>
            <div class="time-inputs">
                 <div class="form-group">
                    <label>Day</label>
                    <select name="slotDay_${weekIndex}_${timeSlotCounts[weekIndex]}" required>
                        <option value="">Select...</option>
                        ${['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].map(d => `<option value="${d}">${d}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>Start time</label>
                     <select name="slotStart_${weekIndex}_${timeSlotCounts[weekIndex]}" required>
                         <option value="">Select...</option>
                        ${Array.from({length: 17}, (_, i) => i + 6).map(h => `<option value="${String(h).padStart(2,'0')}:00">${h%12||12}:00 ${h<12?'AM':'PM'}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>End time</label>
                     <select name="slotEnd_${weekIndex}_${timeSlotCounts[weekIndex]}" required>
                        <option value="">Select...</option>
                        ${Array.from({length: 17}, (_, i) => i + 7).map(h => `<option value="${String(h).padStart(2,'0')}:00">${h%12||12}:00 ${h<12?'AM':'PM'}</option>`).join('')}
                    </select>
                </div>
            </div>`;
        container.appendChild(slotDiv);
    }

    // --- INITIALIZATION & SUBMISSION ---
    async function initializeForm() {
        try {
            const response = await fetch('https://dustbusters-n8n.duckdns.org/webhook/cleaners-list');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            if (!data.success || !Array.isArray(data.cleaners)) throw new Error('Invalid data format');

            const select = document.getElementById('cleanerName');
            data.cleaners.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
            
            const urlParams = getUrlParams();
            if (urlParams.name) select.value = urlParams.name;
            
            const today = new Date();
            const daysUntilMonday = (8 - today.getDay()) % 7 || 7;
            const nextMonday = new Date(today);
            nextMonday.setDate(today.getDate() + daysUntilMonday);
            
            for (let i = 0; i < 4; i++) {
                const weekDate = new Date(nextMonday);
                weekDate.setDate(nextMonday.getDate() + (i * 7));
                weekStartDates.push(weekDate);
            }

            generateWeekForms();
            updateProgressBar();
            document.getElementById('loadingMessage').classList.add('hidden');
            document.getElementById('mainForm').classList.remove('hidden');

        } catch (error) {
            console.error('Init error:', error);
            document.getElementById('loadingMessage').innerHTML = `<div class="error">Failed to load: ${error.message}. Please refresh.</div>`;
        }
    }

    document.getElementById('availabilityForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = document.querySelector('.submit-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';

        const cleanerName = document.getElementById('cleanerName').value;
        const submissions = [];

        for (let i = 0; i < 4; i++) {
            // THIS IS THE FIX: Trace back to the original source data
            let data = weeklyData[i];
            let sourceIndex = i;
            while (data && data.submissionType === 'sameAsPrevious' && sourceIndex > 0) {
                sourceIndex--;
                data = weeklyData[sourceIndex];
            }
            
            // If after tracing we still don't have data, skip this week
            if (!data || Object.keys(data).length === 0) continue;


            let submissionTypeText = '';
            if (data.submissionType === 'eachDay') {
                submissionTypeText = '📝 Fill out each day';
            } else if (data.submissionType === 'timeSlots') {
                submissionTypeText = '⏰ I can only work specific hours (part-time)';
            } else {
                 // Handle case where copied data still needs a type string
                 // This assumes the source data will have a valid type
                if (data.days) submissionTypeText = '📝 Fill out each day';
                if (data.timeSlots) submissionTypeText = '⏰ I can only work specific hours (part-time)';
            }


            const payload = {
                'Submission ID': crypto.randomUUID(),
                'Submission time': new Date().toISOString().slice(0, 19).replace('T', ' '),
                'Your Name:': cleanerName,
                'Week Starting (Monday)': weekStartDates[i].toISOString().split('T')[0],
                'How would you like to submit your availability?': submissionTypeText,
            };

            // Initialize all fields to match n8n processing logic
            for(let j=1; j<=7; j++) {
                payload[`Which day can you work? (Time Slot ${j})`] = '';
                payload[`Start time (Time Slot ${j})`] = '';
                payload[`End time (Time Slot ${j})`] = '';
            }
             // Handle the special case for the first end time slot
            payload['End time (Time Slot 1) (1)'] = '';

            ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].forEach(d => payload[`${d} Availability`] = '');

            if (data.days) {
                Object.assign(payload, {
                    'Monday Availability': data.days?.monday || '', 'Tuesday Availability': data.days?.tuesday || '',
                    'Wednesday Availability': data.days?.wednesday || '', 'Thursday Availability': data.days?.thursday || '',
                    'Friday Availability': data.days?.friday || '', 'Saturday Availability': data.days?.saturday || '',
                    'Sunday Availability': data.days?.sunday || '',
                });
            } else if (data.timeSlots) {
                data.timeSlots.forEach((slot, j) => {
                    const formatTo12Hour = (time24) => {
                        if (!time24) return '';
                        const [hour, minute] = time24.split(':');
                        const h = parseInt(hour);
                        const ampm = h >= 12 ? 'PM' : 'AM';
                        const h12 = h % 12 || 12;
                        return `${h12}:${minute} ${ampm}`;
                    };

                    const slotNum = j + 1;
                    payload[`Which day can you work? (Time Slot ${slotNum})`] = slot.day;
                    payload[`Start time (Time Slot ${slotNum})`] = formatTo12Hour(slot.start);
                    
                    if (slotNum === 1) {
                        payload['End time (Time Slot 1)'] = formatTo12Hour(slot.end);
                        payload['End time (Time Slot 1) (1)'] = formatTo12Hour(slot.end);
                    } else {
                        payload[`End time (Time Slot ${slotNum})`] = formatTo12Hour(slot.end);
                    }
                });
            }
            submissions.push(payload);
        }

        try {
            for (const payload of submissions) {
                const response = await fetch('https://dustbusters-n8n.duckdns.org/webhook/submit-availability', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!response.ok) throw new Error(`Submission failed for week starting ${payload['Week Starting (Monday)']}`);
                const result = await response.json();
                if (!result.success) throw new Error('Server indicated submission failure.');
            }
            
            document.getElementById('mainForm').classList.add('hidden');
            document.getElementById('successMessage').classList.remove('hidden');
        } catch (error) {
            showError(`Submission Failed: ${error.message}. Please try again.`);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit All 4 Weeks';
        }
    });

    document.addEventListener('DOMContentLoaded', initializeForm);
</script>
</body>
</html>

